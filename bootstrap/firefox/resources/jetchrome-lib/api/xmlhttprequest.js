"use strict";const Chrome=require("chrome");const Cc=Chrome.Cc,Ci=Chrome.Ci;const Logger=require("utils-sf/logger").Logger;var requests=[];const TERMINATE_EVENTS=["load","error","abort"];const READ_ONLY_PROPS=["readyState","responseText","status","statusText","withCredentials"];const DELEGATED_METHODS=["abort","getAllResponseHeaders","getResponseHeader","overrideMimeType","send","sendAsBinary","setRequestHeader","open"];var getRequestCount=exports.getRequestCount=function getRequestCount(){return requests.length};const domParser=Cc["@mozilla.org/xmlextras/domparser;1"].createInstance(Ci.nsIDOMParser);const serializer=Cc["@mozilla.org/xmlextras/xmlserializer;1"].createInstance(Ci.nsIDOMSerializer);exports.inject=function(extension,window,contentWindow){const XMLHttpRequestFactory=function(base){base.prototype={_init:function(){var req=Cc["@mozilla.org/xmlextras/xmlhttprequest;1"].createInstance(Ci.nsIXMLHttpRequest);req.mozBackgroundRequest=true;memory.track(req,"XMLHttpRequest");this._req=req;this._orsc=null;requests.push(this);var self=this;this._boundCleanup=function _boundCleanup(){self._cleanup()};TERMINATE_EVENTS.forEach(function(name){self._req.addEventListener(name,self._boundCleanup,false)})},_cleanup:function _cleanup(){this.onreadystatechange=null;var index=requests.indexOf(this);if(index!=-1){var self=this;TERMINATE_EVENTS.forEach(function(name){self._req.removeEventListener(name,self._boundCleanup,false)});requests.splice(index,1)}},_unload:function _unload(){this._req.abort();this._cleanup()},addEventListener:function addEventListener(){this._req.addEventListener.apply(this._req,arguments)},removeEventListener:function removeEventListener(){this._req.removeEventListener.apply(this._req,arguments)},set upload(newValue){throw new Error("not implemented")},get onreadystatechange(){return this._orsc},set onload(handler){if(typeof handler=="function"){this._req.addEventListener("load",handler,false)}},set onerror(handler){if(typeof handler=="function"){this._req.addEventListener("error",handler,false)}},set onreadystatechange(cb){this._orsc=cb;if(cb){var self=this;this._req.onreadystatechange=function(){self._orsc.apply(self,arguments)}}else{this._req.onreadystatechange=null}}};READ_ONLY_PROPS.forEach(function(name){base.prototype.__defineGetter__(name,function(){return this._req[name]})});base.prototype.__defineGetter__("responseXML",function(){return this._req.responseXML&&(this._req.responseXML.wrappedJSObject||contentWindow.DOMParser().parseFromString(serializer.serializeToString(this._req.responseXML),"text/xml"))});DELEGATED_METHODS.forEach(function(name){base.prototype[name]=function(){return this._req[name].apply(this._req,arguments)}});return base};require("unload").when(function(){requests.slice().forEach(function(request){request._unload()})});contentWindow.XMLHttpRequestFactory=XMLHttpRequestFactory;contentWindow.eval("XMLHttpRequest=XMLHttpRequestFactory(function(){this._init();});")};