"use strict";const self=require("self");const Arguments=require("utils-sf/arguments");const Assert=require("test/assert").Assert;const Logger=require("utils-sf/logger").Logger;const chromeAPI=JSON.parse(self.data.load("format/chrome.json"));const support=JSON.parse(self.data.load("support/chrome.json"));function isSupported(a){return support.indexOf(a)==-1}exports.inject=function(g,d,b){b.chrome={};var a=b.chrome;b.chrome._listener=b.chrome._listener||{};var e=b.chrome._listener;for(var c in chromeAPI){a[c]={};(chromeAPI[c].events||[]).forEach(function(j){var i="on"+j[0].toUpperCase()+j.slice(1);var l=["chrome",c,i].join(".");var k=function(){Logger.warn(l+": not currently supported")};var h=isSupported(l);a[c][i]={addListener:h?(function(m,n){return function(p){var o=[m,n].join(":");if(!(o in e)){e[o]=[]}e[o].push(p)}})(c,j):k,removeListener:h?(function(m,n){return function(p){var o=[m,n].join(":");if(!(o in e)){e[o]=[]}e[o]=e[o].filter(function(q){return q!=p})}})(c,j):k,hasListener:h?(function(m,n){return function(p){var o=[m,n].join(":");return e[o]&&e[o].indexOf(p)!=-1}})(c,j):k}});if(chromeAPI[c].type=="object"&&chromeAPI[c].children){var f=chromeAPI[c].permission==true?g.hasPermission(c):true;Object.keys(chromeAPI[c].children).forEach(function(h){var i=chromeAPI[c].children[h];var j=["chrome",c,h].join(".");switch(i.type){case"function":a[c][h]=isSupported(j)?(function(m,k,l){return function(){var n;try{if(!l){throw new Error("You do not have permission to use '"+j+"'. Be sure to declare in your manifest what permissions you need.")}Arguments.check(arguments,i.arguments);n=m=="extension"?g:g.api[m];if(!n){throw new Error("This extension has no "+m+" specified.")}if(!(k in n)){throw new Error("This function is not implemented")}}catch(p){return Logger.error(new Error([j,p.message].join(":"),p.fileName,p.lineNumber))}var o=Array.prototype.slice.call(arguments,0);return n[k].apply(n,arguments)}})(c,h,f||(i.permission==false)):function(){Logger.warn(j+": not currently supported")};break;default:a[c].__defineGetter__(h,isSupported(j)?function(){return(c=="extension"?g:g.getAPI(c))[h]}:function(){Logger.warn(j+": not currently supported");return null})}})}}a.tabs.getCurrent=g.api.tabs.getCurrent.bind(g.api.tabs,d);a.windows.getCurrent=g.api.windows.getCurrent.bind(g.api.tabs,b)};